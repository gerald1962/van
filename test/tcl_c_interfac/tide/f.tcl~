#!/usr/bin/tclsh

# cock - Cable Controller Knob

# Load dynmically the van OS into the statically-linked interpreter.
load ../../../lib/libvan[info sharedlibextension]

# Welcoming.
puts "Cable Controller Knob"

# Connect the display-controller cable.
set c [cable display]

# Trace the displace entry point name.
puts "Cable access name: $c"

# Initialize the message counter.
set i 0

# Read or write controller messages.
while { 1 } {
    # Read a message from the display input queue of the display-controller cable.
    set n [gets $c msg]

    # Test the message length.
    if { $n < 1} {
	continue
    }

    # Trace the input message.
    puts "D> rcvd: \[m=\"$msg\", l=$n\]"

    # Analyze the message contents.
    if { $msg == "That's it." } {
	break
    }

    # Test the input message.
    if { $msg != $i } {
	error "input error: see trace"
    }
    
    # Get back the message to the controller.
    puts $c $msg
    flush $c

    # Increment the message counter.
    incr i
}

# Pull out the display plug.
close $c
